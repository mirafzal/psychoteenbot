<?php

include 'Telegram.php';
include 'Texts.php';///////////
include 'CallbackData.php';/////////////

$telegram = new Telegram('1192533019:AAHB-xbDuhTbePKEPqH6Hh3mH_gBEJ7DL6U');//'1114225171:AAGMKr9CuaWGvqCChDczlG0JJkmyVS0b_7w');

$result = $telegram->getData();
$text = $result['message'] ['text'];
$chat_id = $result['message'] ['chat']['id'];
$username = $result['message'] ['chat']['username'];
$firstname = $result['message'] ['chat']['first_name'];
$lastname = $result['message'] ['chat']['last_name'];

$admin_chat_ids = [635793263, 583412087, 676244920];

if (!file_exists("counter.txt")) {
	file_put_contents("counter.txt", 1);
}

if ($chat_id == null) {

    $chat_id = 635793263;

}

$callback_query = $telegram->Callback_Query();

$id = substr(file_get_contents($chat_id."step.txt"), 7);
echo $id;

$txt = json_encode($telegram->getData(), JSON_PRETTY_PRINT);

$content = array('chat_id' => $telegram->ChatID(), 'text' => $txt);
$telegram->sendMessage($content);

$voiceFileID = "AwACAgIAAxkBAAICM16XSgcOToNROJKpArwYbpsE8Lc1AAJ5BwACjl-4SONiukfFgQurGAQ";
    $option = [
        [$telegram->buildInlineKeyBoardButton(Texts::BTN_WRITE_ANSWER, "", CallbackData::ACCEPT)],
        [$telegram->buildInlineKeyboardButton(Texts::BTN_NOT_CORRECT_QUESTION, "", CallbackData::REJECT)],
        [$telegram->buildInlineKeyboardButton(Texts::BTN_BACK, "", CallbackData::CANCEL)],
    ];
    $keyb = $telegram->buildInlineKeyBoard($option);
    $content = array('chat_id' => $telegram->ChatID(),
        'voice' => $voiceFileID,
        'caption' => 'gergnvlerhbgvlrtbg', 'reply_markup' => $keyb);
    $telegram->sendVoice($content);


// test file reading
//
// $questionsFile = fopen("questions.txt", "a+") or die("Unable to open file!");
// 		$option = [];
// 		while(!feof($questionsFile)) {
// 			$line = fgets($questionsFile);
// 			if ($line == "") {
// 				break;
// 			}
//   			$word_arr = explode("*^*", $line);
//   			echo $word_arr[0]." ".$word_arr[1]." ".$word_arr[2]."<br>";
//   	// 		$contents = file_get_contents("questions.txt");
// 			// $contents = str_replace($line, '', $contents);
// 			// file_put_contents("questions.txt", $contents);
// 		}

if (in_array($chat_id, $admin_chat_ids)) { //admin panel
	if ($callback_query !== null && $callback_query != '') {

		//answer nothing with answerCallbackQuery, because it is required

    	$content = ['callback_query_id' => $telegram->Callback_ID(), 'text' => '', 'show_alert' => false];

    	$telegram->answerCallbackQuery($content);

    	$callback_data = $telegram->Callback_Data();

    	$chat_id = $telegram->Callback_ChatID();

    	$questionsFile = fopen("questions.txt", "a+") or die("Unable to open file!");

    	$option = [
    		[$telegram->buildKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å")],
    	];
		$keyb = $telegram->buildKeyBoard($option, $onetime=false,  $resize=true);
		while(!feof($questionsFile)) {
			$line = fgets($questionsFile);
			if ($line == "") {
				break;
			}
  			$word_arr = explode("*^*", $line);
  			if ($word_arr[0] == $callback_data) {
  				file_put_contents($chat_id."step.txt", "answer ".$word_arr[0]);
  		    	$content = array('chat_id' => $chat_id, 'reply_markup' => $keyb, 'text' => "–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç.\n–í–æ–ø—Ä–æ—Å:\n".$word_arr[2]);
				$telegram->sendMessage($content);
  				break;
  			}
		}
		fclose($questionsFile);

	} elseif ($text == "/start" || $text == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å") {
		$option = [
    		[$telegram->buildKeyboardButton("–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã")],
    	];
		$keyb = $telegram->buildKeyBoard($option, $onetime=false,  $resize=true);
		$content = array('chat_id' => $chat_id, 'reply_markup' => $keyb, 'text' => "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.");
		$telegram->sendMessage($content);		

		file_put_contents($chat_id."step.txt", "main");
	} elseif (strpos(file_get_contents($chat_id."step.txt"), "answer") !== false) {
		$id = substr(file_get_contents($chat_id."step.txt"), 7);

    	$questionsFile = fopen("questions.txt", "a+") or die("Unable to open file!");

		while(!feof($questionsFile)) {
			$line = fgets($questionsFile);
			if ($line == "") {
				break;
			}
  			$word_arr = explode("*^*", $line);
  			if ($word_arr[0] == $id) {
  				//asnwer is ready
  		    	$content = array('chat_id' => $word_arr[1], 'text' => "‚úÖ –í–∞—à –æ—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤!\n\n–í–æ–ø—Ä–æ—Å:\n".$word_arr[2]."\n–û—Ç–≤–µ—Ç:\n".$text);
				$telegram->sendMessage($content);
				//please rate us!
				$option = [
					[$telegram->buildInlineKeyBoardButton("üëç", $url = "", $callback_data = "good"), 
					 $telegram->buildInlineKeyBoardButton("üëé", $url = "", $callback_data = "bad")]
				];
				$keyb = $telegram->buildInlineKeyBoard($option);
				$content = array('chat_id' => $word_arr[1], 'reply_markup' => $keyb, 'text' => "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞—à–µ–π —É—Å–ª—É–≥–∏! üòá");
				$telegram->sendMessage($content);

				file_put_contents($word_arr[1]."step.txt", "rating");
				//dev log
				$content = array('chat_id' => 635793263, 'text' => "(–†–∞–∑—Ä–∞–±) –û—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤.\n\n–í–æ–ø—Ä–æ—Å:\n".$word_arr[2]."\n–û—Ç–≤–µ—Ç:\n".$text);
				$telegram->sendMessage($content);

				$contents = file_get_contents("questions.txt");
				$contents = str_replace($line, '', $contents);
				file_put_contents("questions.txt", $contents);
  				break;
  			}
		}
		fclose($questionsFile);

		$content = array('chat_id' => $chat_id, 'text' => "–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ.");
		$telegram->sendMessage($content);

		$option = [
    		[$telegram->buildKeyboardButton("–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã")],
    	];
		$keyb = $telegram->buildKeyBoard($option, $onetime=false,  $resize=true);
		$content = array('chat_id' => $chat_id, 'reply_markup' => $keyb, 'text' => "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.");
		$telegram->sendMessage($content);		

		file_put_contents($chat_id."step.txt", "main");
	} elseif ($text == "–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã") {
		if (file_get_contents("questions.txt") == "") {
			$content = array('chat_id' => $chat_id, 'text' => "–í–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç.");
			$telegram->sendMessage($content);
		} else {
			$questionsFile = fopen("questions.txt", "a+") or die("Unable to open file!");
			$option = [];
			while(!feof($questionsFile)) {
				$line = fgets($questionsFile);
				if ($line == "") {
				break;
				}
  				$word_arr = explode("*^*", $line);
  				$option[] = [$telegram->buildInlineKeyBoardButton($word_arr[0], $url = "", $callback_data = $word_arr[0])];
			}
			fclose($questionsFile);
			$keyb = $telegram->buildInlineKeyBoard($option);
			$content = array('chat_id' => $chat_id, 'reply_markup' => $keyb, 'text' => "–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å:");
			$telegram->sendMessage($content);

			file_put_contents($chat_id."step.txt", "main");
		}
	} 

} else { //user panel

if ($callback_query !== null && $callback_query != '') {

	    	//answer nothing with answerCallbackQuery, because it is required

    	$content = ['callback_query_id' => $telegram->Callback_ID(), 'text' => '', 'show_alert' => false];

    	$telegram->answerCallbackQuery($content);

    	$callback_data = $telegram->Callback_Data();

    	$chat_id = $telegram->Callback_ChatID();

    	if (file_get_contents($chat_id."step.txt") == "rating") {
    		$content = ['chat_id' => $chat_id, 'text' => "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! üòä"];
    		$telegram->sendMessage($content);

    		if ($callback_data == "good") {
    			for ($i=0; $i < count($admin_chat_ids); $i++) { 
					$content = array('chat_id' => $admin_chat_ids[$i], 'text' => "–û—Ç–∑—ã–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n–ò–º—è: ".$telegram->FirstName()."\n–§–∞–º–∏–ª–∏—è: ".$telegram->LastName()."\nusername: @".
						$telegram->Username()."\n–û—Ü–µ–Ω–∫–∞: üëç");
					$telegram->sendMessage($content);
				}
    		} elseif ($callback_data == "bad") {
    			for ($i=0; $i < count($admin_chat_ids); $i++) { 
					$content = array('chat_id' => $admin_chat_ids[$i], 'text' => "–û—Ç–∑—ã–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n
						–ò–º—è: ".$telegram->FirstName()."\n –§–∞–º–∏–ª–∏—è: ".$telegram->LastName()."\nusername: ".
						$telegram->Username()."\n–û—Ü–µ–Ω–∫–∞: üëé");
					$telegram->sendMessage($content);
				}    			
    		}

    		file_put_contents($chat_id."step.txt" , "main");

    		$content = ['chat_id' => $chat_id, 'text' => "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! üòä"];
    		$telegram->sendMessage($content);
    	}



	} elseif ($text == "/start" || $text == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å") {
	$option = [
    	[$telegram->buildKeyboardButton("‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å")], 
    	[$telegram->buildKeyboardButton("‚ÑπÔ∏è –û –±–æ—Ç–µ")],
    ];
	$keyb = $telegram->buildKeyBoard($option, $onetime=false,  $resize=true);
	$content = array('chat_id' => $chat_id, 'reply_markup' => $keyb, 'text' => "üì£ –î–æ–±—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫! –ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–∏ —á–∞—Å–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ! üíØ
‚ö†Ô∏è–ê–∫—Ü–∏—è –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ xx —á–∏—Å–ª–∞.");
	$telegram->sendMessage($content);

	file_put_contents($chat_id."step.txt", "main");
} elseif ($text == "‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å") {
	$option = [
    	[$telegram->buildKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å")],
    ];
	$keyb = $telegram->buildKeyBoard($option, $onetime=false,  $resize=true);
	$content = array('chat_id' => $chat_id, 'reply_markup' => $keyb, 'text' => "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å.");
	$telegram->sendMessage($content);

	file_put_contents($chat_id."step.txt", "question");
} elseif ($text == "‚ÑπÔ∏è –û –±–æ—Ç–µ") {
	$content = array('chat_id' => $chat_id, 'text' => "‚ùóÔ∏è–ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–û –ò –ë–ï–°–ü–õ–ê–¢–ù–û‚ùóÔ∏è
üì¢ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –æ–Ω–ª–∞–π–Ω –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∞-—Ç–µ—Ä–∞–ø–µ–≤—Ç–∞ –¥–ª—è –ø–æ–¥—Ä–æ—Å—Ç–æ–∫–æ–≤ –≤ –≤–æ–∑—Ä–∞—Å—Ç–µ 13-19 –ª–µ—Ç –≤ —Å—Ñ–µ—Ä–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π. üíï

PsychoTeen —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π –∏ –æ–ø–µ–∫—É–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç, —á—Ç–æ–±—ã –∏—Ö —Ä–µ–±–µ–Ω–æ–∫ –ø–æ–ª—É—á–∏–ª –∑–∞—Å–ª—É–∂–µ–Ω–Ω—É—é –ø–æ–º–æ—â—å.

–¶–µ–ª—å PsychoTeen - –ø–æ–º–æ—á—å –ø–æ–¥—Ä–æ—Å—Ç–∫–∞–º —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏, —Ç–∞–∫–∏–º–∏ –∫–∞–∫ –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ, —Å—Ç—Ä–µ—Å—Å, —á—É–≤—Å—Ç–≤–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞, –¥–µ–ø—Ä–µ—Å—Å–∏—è, –∏–∑–¥–µ–≤–∞—Ç–µ–ª—å—Å—Ç–≤–∞, —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–∏—â–µ–≤–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è, –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏–ª–∏ –≥–Ω–µ–≤.");
	$telegram->sendMessage($content);
} elseif (file_exists($chat_id."step.txt") && (file_get_contents($chat_id."step.txt") == "question")) {
	$option = [
    	[$telegram->buildKeyboardButton("‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å")], 
    	[$telegram->buildKeyboardButton("‚ÑπÔ∏è –û –±–æ—Ç–µ")],
    ];
	$keyb = $telegram->buildKeyBoard($option, $onetime=false,  $resize=true);
	$content = array('chat_id' => $chat_id, 'reply_markup' => $keyb, 'text' => "‚ôªÔ∏è–í–∞—à –≤–æ–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç. –ü–µ—Ä–≤—ã–π –æ—Å–≤–æ–±–æ–¥–∏–≤—à–∏–π—Å—è –ø—Å–∏—Ö–æ–ª–æ–≥ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—Å—è —Å –í–∞—à–µ–π –ø—Ä–æ–±–ª–µ–º–æ–π –∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.");
	$telegram->sendMessage($content);

	$questionsFile = fopen("questions.txt", "a+") or die("Unable to open file!");

	$counter = file_get_contents("counter.txt");

	fwrite($questionsFile, $counter."*^*".$chat_id."*^*".$text."\n");

	$content = array('chat_id' => 635793263, 'text' => "(–†–∞–∑—Ä–∞–±) ".$counter."*^*".$chat_id."*^*".$text."\n");
	$telegram->sendMessage($content);	

	file_put_contents("counter.txt", $counter + 1);

	fclose($questionsFile);

	for ($i=0; $i < count($admin_chat_ids); $i++) { 
		$content = array('chat_id' => $admin_chat_ids[$i], 'text' => "–ü–æ—Å—Ç—É–ø–∏–ª –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å");
		$telegram->sendMessage($content);
	}

	file_put_contents($chat_id."step.txt", "main");
}

}